# =========================================================
# CONFIGURATION DE L'API MADRID

# Ce service gère le chargement des modèles Scikit-Learn
# et expose les routes FastAPI sur le port 8000.

# Communication : Dans app.py, utilise http://api:8000/predict.
# Docker Compose lie les services par leur nom (api) via son réseau interne.
# Fiabilité : Healthcheck à 10s pour un démarrage rapide de Streamlit après l'API.
# Dev : Les volumes répercutent tes modifs Windows (api.py) sans rebuild.

# =========================================================

services:
  # Bloc pour le Back, l'API
  api:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: apartment-api
    ports:
      - "8000:8000"
    environment:
      - PYTHONUNBUFFERED=1
    volumes:
      - .:/app
      - /app/.venv  # Volume anonyme pour isoler l'environnement Linux
      - ./models:/app/models:ro
      - ./data_model:/app/data_model:ro

  # Bloc pour le front, l'interface Streamlit
  streamlit:
    build:
      context: .
      dockerfile: Dockerfile.streamlit
    container_name: apartment-streamlit
    ports:
      - "8501:8501"
    environment:
      - PYTHONUNBUFFERED=1
    depends_on:
      - api
    volumes:
      - .:/app
      - /app/.venv  # Indispensable pour éviter le conflit avec Windows
      - ./streamlit_app:/app/streamlit_app
    command: uv run streamlit run streamlit_app/app.py --server.port=8501 --server.address=0.0.0.0